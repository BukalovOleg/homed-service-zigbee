.build:
  stage: build
  script:
  - "[ ! -z \"${COMPILER}\" ] && export PATH=\"$PATH:/opt/${COMPILER}/bin\""
  - "[ ! -z \"${COMPILER}\" ] && export STAGING_DIR=\"/opt/${COMPILER}\""
  - "/opt/${QT_BUILD}/bin/qmake homed-zigbee.pro"
  - "make -j8"
  - "cp homed-zigbee homed-zigbee-${ARCHITECTURE}"
  artifacts:
    paths:
    - "homed-zigbee-${ARCHITECTURE}"
    expire_in: 1 day
  except:
    - branches
  only:
    - /^\d.\d.\d+$/
    - dev

.deploy_apt:
  stage: deploy
  variables:
    PACKAGE_FILE: homed-zigbee_${CI_COMMIT_TAG}_${ARCHITECTURE}.deb
  script:
  - "mkdir -p deploy/data/lib/systemd/system"
  - "mkdir -p deploy/data/usr/local/bin"
  - "cp -r deploy/debian deploy/data/DEBIAN"
  - "cp deploy/systemd/homed-zigbee.service deploy/data/lib/systemd/system"
  - "cp homed-zigbee-${ARCHITECTURE} deploy/data/usr/local/bin/homed-zigbee"
  - "md5deep -lr deploy/data | grep -v DEBIAN | sed \"s+deploy/data/++g\" | sort -k2 > deploy/data/DEBIAN/md5sums"
  - "sed -i \"s+^Version:.*+Version: ${CI_COMMIT_TAG}+g\" deploy/data/DEBIAN/control"
  - "sed -i \"s+^Architecture:.*+Architecture: ${ARCHITECTURE}+g\" deploy/data/DEBIAN/control"
  - "chmod +x deploy/data/DEBIAN/postinst"
  - "chmod +x deploy/data/DEBIAN/prerm"
  - "fakeroot dpkg-deb --build deploy/data"
  - "mv deploy/data.deb ${PACKAGE_FILE}"
  - "reprepro -b /var/lib/apt -C main includedeb debian ${PACKAGE_FILE}"
  artifacts:
    paths:
    - ${PACKAGE_FILE}
    expire_in: never
  except:
    - branches
  only:
    - /^\d.\d.\d+$/

.deploy_ipk:
  stage: deploy
  variables:
    PACKAGE_FILE: homed-zigbee_${CI_COMMIT_TAG}_${ARCHITECTURE}.ipk
  script:
  - "mkdir -p deploy/data/etc/init.d"
  - "mkdir -p deploy/data/usr/bin"
  - "mkdir -p deploy/data/var/db"
  - "cp deploy/procd/homed-zigbee deploy/data/etc/init.d"
  - "cp homed-zigbee-${ARCHITECTURE} deploy/data/usr/bin/homed-zigbee"
  - "sed -i \"s+^Version:.*+Version: ${CI_COMMIT_TAG}+g\" deploy/openwrt/control"
  - "echo \"2.0\" > debian-binary"
  - "chmod +x deploy/data/etc/init.d/homed-zigbee"
  - "chmod +x deploy/openwrt/postinst"
  - "chmod +x deploy/openwrt/prerm"
  - "fakeroot tar -czf control.tar.gz -C deploy/openwrt ."
  - "fakeroot tar -czf data.tar.gz -C deploy/data ."
  - "fakeroot tar -czf ${PACKAGE_FILE} control.tar.gz data.tar.gz debian-binary"
  artifacts:
    paths:
    - ${PACKAGE_FILE}
    expire_in: never
  except:
    - branches
  only:
    - /^\d.\d.\d+$/

Build Linux Binary (x86_64):
  extends: .build
  variables:
    ARCHITECTURE: x86_64
    QT_BUILD: qt-x86_64-5.15.4-static

Build Linux Binary (aarch64):
  extends: .build
  variables:
    ARCHITECTURE: aarch64
    QT_BUILD: qt-aarch64-5.15.4-static
    COMPILER: gcc-aarch64-linux-gnu

Build Linux Binary (armhf):
  extends: .build
  variables:
    ARCHITECTURE: armhf
    QT_BUILD: qt-armhf-5.15.4-static
    COMPILER: gcc-arm-linux-gnueabihf

Build OpenWRT Binary (mips):
  extends: .build
  variables:
    ARCHITECTURE: mips_24kc
    QT_BUILD: qt-mips-5.15.4-static
    COMPILER: gcc-mips-openwrt-linux

Deploy Docker Images:
  stage: deploy
  script:
  - "cp homed-zigbee-x86_64 deploy/docker/homed-zigbee-amd64"
  - "cp homed-zigbee-aarch64 deploy/docker/homed-zigbee-arm64"
  - "cp homed-zigbee-armhf deploy/docker/homed-zigbee-arm"
  - "cp deploy/data/usr/share/homed/zigbee.json deploy/docker/"
  - "docker buildx create --driver-opt network=host --name job_${CI_JOB_ID} --use"
  - "docker buildx build --platform linux/arm64,linux/arm/v7,linux/amd64 --push --tag 127.0.0.1:5000/homed-zigbee:${CI_COMMIT_TAG} --tag 127.0.0.1:5000/homed-zigbee:latest deploy/docker/"
  - "docker buildx prune -af"
  - "docker buildx rm"
  except:
    - branches
  only:
    - /^\d.\d.\d+$/
    - dev

Deploy APT Package (aarch64):
  extends: .deploy_apt
  variables:
    ARCHITECTURE: aarch64

Deploy APT Package (armhf):
  extends: .deploy_apt
  variables:
    ARCHITECTURE: armhf

Deploy OpenWRT Package (mips):
  extends: .deploy_ipk
  variables:
    ARCHITECTURE: mips_24kc
